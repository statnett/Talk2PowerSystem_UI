{{- $backend := required "The backend URL is required!" .Values.configuration.backend.url -}}
{{- $backendUrl := urlParse $backend -}}
{{- $chatContextPath := trimSuffix "/" .Values.configuration.contextPath -}}
{{- $backendLocPath := printf "%s/rest/" $chatContextPath -}}
{{- $graphdbLocPath := printf "%s/graphdb/" $chatContextPath -}}
server {
  listen 8080;
  server_name localhost {{ $backendUrl.hostname }};

  # Proxies the request for the Chatbot service to the correct address.
  location ~ ^{{ printf "%s" $backendLocPath }}(.*)$ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    set $upstream {{ printf "%s/rest/" ($backend | trimSuffix "/") }};
    proxy_pass $upstream$1;
  }

  # Strips the '/chat' context path when redirecting to GraphDB
  location ^~ {{ printf "%s" $graphdbLocPath }} {
    rewrite ^{{ printf "%s" $graphdbLocPath }}(.*)$ /graphdb/$1 permanent;
  }
}
